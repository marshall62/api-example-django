{% extends 'navbar_page.html' %}

{% block page-js %}
  <script language="javascript">

  var clock = new Date.now();

  function saveStat (appt_id, status) {
    var data = new FormData();
    data.set('status',status);
    var url = "/appointments/" + appt_id;
    $.ajax({
      url: url,
      type: "POST",
      data: data,
      processData: false,
      contentType: false,
      error: function (a, b, c) {
        console.log("Failed to write to server! " + a.responseText + b);
        console.log(a);
      },
      success: function (data) {
        console.log("success", data);
      }
    });
  }

  // WHen dr changes status of a patient, the row is removed from whatever table its in and inserted
  // into whatever table it should go to (e.g. a pt in the waiting room with new status of In Session moves
  // to the examTable).  The row can be used as-is in the new table except its final cell holding the
  // dropdown menu needs to be replaced so it has appropriate menu selections for the new table.
  function moveToTable ($rowElt, $tbody, menuItems, selectedOption) {
    var appt_id = $rowElt.data('appointment-id');
    var $ddTd = $rowElt.find('td').last();
    $ddTd.empty(); // eliminate the dropdown menu out of the last cell in the row

    // create new dropdown, set initially to selectedOption
    var dd = '<div class="dropdown">' +
        '              <button class="btn btn-primary dropdown-toggle" type="button" ' +
        '                      data-toggle="dropdown">' + selectedOption +
        '                <span class="caret"></span></button>' +
        '              <ul class="dropdown-menu">';
    // add in the menu items to the dropdown
    for (var [stat, menuLabel] of Object.entries(menuItems))
      dd += '<li><a class="status" data-stat="' +stat+ '" data-appointment-id="' +appt_id+ '">' +menuLabel+ '</a></li>'
    dd += '</ul></div>';
    $ddTd.append(dd); // add the cell to the row
    $tbody.append($rowElt); // add the row to table

  }


  function statusUpdate (aElt, appointmentId, newStatus) {
    saveStat(appointmentId, newStatus);

    // if status is complete, remove the row
    var $row = aElt.closest("tr");
    if (newStatus === "complete")
      $row.remove();
    else if (newStatus === 'waiting') {
      $row.remove();
      moveToTable($row, $('#waitingTableBody'), {'exam': 'In Session', 'absent': 'No Show'}, 'Checked In')
    }
    else if (newStatus === 'exam') {
      $row.remove();
      moveToTable($row, $('#examTableBody'), {'complete': 'Complete', 'waiting': 'Checked In'}, 'In Session')
    }
  }

  $( document ).ready(function () {
    // status dropdown items click handling
    $(document).on('click', '.status', function () {
      var $e = $(this);
      var stat = $e.data('stat');
      var proceed = true;
      if (stat === 'complete')
          proceed = confirm("Proceed with status change to " + $e.text());
      if (proceed) {
        $e.parents(".dropdown").find('.btn').html($e.text() + ' <span class="caret"></span>');
        $e.parents(".dropdown").find('.btn').val($e.data('stat'));
        statusUpdate($e, $e.attr('data-appointment-id'), $e.data('stat'));
      }
    });


  });

  </script>
{% endblock %}


{% block body %}

<h3>In Exam Rooms</h3>
  <table class="table table-bordered">
    <thead><th>time</th><th>duration</th><th>First</th><th>Last</th><th>Reason</th><th>Status</th></thead>
    <tbody id="examTableBody">
    {% for a in appointments %}
      {% if a.status == 'In Session' %}

        <tr data-appointment-id="{{ a.appointment_id }}">
          <td>{{a.scheduled_time_12hr}}</td>
          <td></td>
          <td>{{a.first_name}}</td>
          <td>{{a.last_name}}</td>
          <td>{{a.reason}}</td>
          <td>
            <div class="dropdown">
              <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">{{ a.status }}
                <span class="caret"></span></button>
              <ul class="dropdown-menu">
                <li><a class="status" data-stat="complete" data-appointment-id="{{ a.appointment_id }}">Complete</a></li>
                <li><a class="status" data-stat="waiting" data-appointment-id="{{ a.appointment_id }}">Checked In</a></li>
              </ul>
            </div>
          </td>
        </tr>
      {% endif %}
    {% endfor %}
    </tbody>
  </table>

<h3>In Waiting Room</h3>
  <table class="table table-bordered">
    <thead><th>time</th><th>overtime</th><th>First</th><th>Last</th><th>Reason</th><th>Status</th></thead>
    <tbody id="waitingTableBody">
    {% for a in appointments %}
      {% if a.status == 'Checked In' or a.status == 'No Show'%}
        <tr data-appointment-id="{{ a.appointment_id }}">
          <td>{{a.scheduled_time_12hr}}</td>
          <td></td>
          <td>{{a.first_name}}</td>
          <td>{{a.last_name}}</td>
          <td>{{a.reason}}</td>
          <td>
            <div class="dropdown">
              <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">{{ a.status }}
                <span class="caret"></span></button>
              <ul class="dropdown-menu">
                <li><a class="status" data-stat="absent" data-appointment-id="{{ a.appointment_id }}">No Show</a></li>
                <li><a class="status" data-stat="exam" data-appointment-id="{{ a.appointment_id }}">In Session</a></li>
              </ul>
            </div>
          </td>
        </tr>
      {% endif %}
    {% endfor %}
    </tbody>
  </table>

<h3>Later Appointments</h3>
    <table class="table table-bordered">
      <thead><th>time</th><th></th><th>First</th><th>Last</th><th>Reason</th><th>Status</th></thead>
    {% for a in appointments %}
      {% if a.status != 'Checked In' and a.status != 'In Session'%}
            <tr>
                <td>{{a.scheduled_time_12hr}}</td>
                <td></td>
                <td>{{a.first_name}}</td>
                <td>{{a.last_name}}</td>
                <td>{{a.reason}}</td>
                <td>{{ a.status }}</td>
            </tr>
      {% endif %}
    {% endfor %}
    </table>
<!--{{ doctor }}-->
{% endblock %}