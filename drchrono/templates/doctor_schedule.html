{% extends 'navbar_page.html' %}

{% block page-js %}
  <script language="javascript">

  var clock = Date.now();


  function saveStat (appt_id, status) {
    var data = new FormData();
    data.set('status',status);
    var url = "/appointments/" + appt_id;
    $.ajax({
      url: url,
      type: "POST",
      data: data,
      processData: false,
      contentType: false,
      error: function (a, b, c) {
        console.log("Failed to write to server! " + a.responseText + b);
        console.log(a);
      },
      success: function (data) {
        console.log("success", data);
      }
    });
  }

  function getScheduledAppointments () {
    var url = "/appointments/" ;
    $.ajax({
      url: url,
      type: "GET",
      error: function (a, b, c) {
        console.log("Failed to get from server! " + a.responseText + b);
        console.log(a);
      },
      success: function (data) {
        console.log("schedule appts", data);
        reloadUpcomingTableAppointments(data['upcoming']);
        reloadWaitingTableAppointments(data['waiting']);
      }
    });
  }

  // dropdown menu for status built for an appointment depends on its current status.
  // menuItems like: {'waiting': 'Checked In', 'absent': 'No Show'}
  function create_status_dropdown (appt_id, selectedOption, menuItems) {
   var dd = '<div class="dropdown">' +
        '              <button class="btn btn-primary dropdown-toggle" type="button" ' +
        '                      data-toggle="dropdown">' + selectedOption +
        '                <span class="caret"></span></button>' +
        '              <ul class="dropdown-menu">';
    // add in the menu items to the dropdown
    for (var [stat, menuLabel] of Object.entries(menuItems))
      dd += '<li><a class="status" data-stat="' +stat+ '" data-appointment-id="' +appt_id+ '">' +menuLabel+ '</a></li>'
    dd += '</ul></div>';
    return dd;
  }

  // WHen dr changes status of a patient, the row is removed from whatever table its in and inserted
  // into whatever table it should go to (e.g. a pt in the waiting room with new status of In Session moves
  // to the examTable).  The row can be used as-is in the new table except its final cell holding the
  // dropdown menu needs to be replaced so it has appropriate menu selections for the new table.
  function moveToTable ($rowElt, $tbody, menuItems, selectedOption) {
    var appt_id = $rowElt.data('appointment-id');
    var $ddTd = $rowElt.find('td').last();
    $ddTd.empty(); // eliminate the dropdown menu out of the last cell in the row
    var dd = create_status_dropdown(appt_id, selectedOption, menuItems);
    $ddTd.append(dd); // add the cell to the row
    $tbody.append($rowElt); // add the row to table

  }

  function alterExamRowTime ($row) {
    // store the cur time as the exam starttime in the row data
    $row.attr('data-exam-starttime', new Date().toISOString());
    // make the time-waited td be a duration td set to 0
    var $td = $row.find('.time-waited');
    $td.html('');
    $td.attr('class', 'duration');
  }

  function alterWaitingRowTime ($row) {
    // store the cur time as the checkin time stored in row data
    $row.attr('data-checkin-time', new Date().toISOString());
    // if the row has a .duration td get rid of it and replace with a time-waited
    var $durtd = $row.find('.duration');
    if ($durtd) {
      $durtd.html('');
      $durtd.attr('class', 'time-waited');
    }
  }

  function statusUpdate (aElt, appointmentId, newStatus) {
    saveStat(appointmentId, newStatus);

    // if status is complete, remove the row
    var $row = aElt.closest("tr");
    if (newStatus === "complete")
      $row.remove();
    else if (newStatus === 'waiting') {
      $row.remove();
      // TODO: Some ugliness here because I've allowed patients in exam to be sent back to waiting.
      // It means the duration td needs to be changed back to a time-waited td with a 0
      alterWaitingRowTime($row);
      moveToTable($row, $('#waitingTableBody'), {'exam': 'In Session', 'absent': 'No Show'}, 'Checked In')
    }
    else if (newStatus === 'exam') {
      $row.remove();
      alterExamRowTime($row); // change the time-waited td to a duration td
      moveToTable($row, $('#examTableBody'), {'complete': 'Complete', 'waiting': 'Checked In'}, 'In Session')
    }
  }


  function toHM (mins, addColor=false) {
    var h = Math.floor(mins / 60);
    var mins = mins % 60;
    var res = "";
    if (h >= 1)
      res += h + ":";
    if (mins >= 10)
      res += mins.toString();
    else if (h >= 1)
      res += "0" + mins.toString();
    else
      res += mins.toString();
    if (addColor) {
      var color = 'red';
      if (h < 1 && mins < 20 && mins > 15)
        color = 'orange';
      else if (h < 1 && mins < 15)
        color = 'black';
      return "<font color='" + color + "'>" + res + "</font>"

    }
    else
      return res;

  }

  // return the elapsed time as HH:MM string
  function calcElapsedTime (startTime) {
    var ms = Date.now()- Date.parse(startTime);
    // want as minutes
    return Math.round(ms / (60 * 1000));
  }

  // The .time-waited td holds how long patient has been in waiting rm.  The timestamp of when status became Checked In is
  // held in the tr's data-checkin-time.  We compute the time diff between now and checkin time and put this in the time-waited td.
  function updateWaitingTableTimes () {
    $('#waitingTableBody tr').each(function () {
      var checkinTime = $(this).data('checkin-time');  // rows in waiting table have checkin-time in yyyy-mm-ddThh:mm:ss format
      var scheduledTime = $(this).data('scheduled-time');  // rows in waiting table have scheduled-time in yyyy-mm-ddThh:mm:ss format
      var timeSinceCheckin = calcElapsedTime(checkinTime); // TODO Maybe this shouldn't matter.  Ignore showing.
      var timeBehindSchedule = calcElapsedTime(scheduledTime);
      if (timeBehindSchedule > 0)
        // show as time-behind-scheduled/time-since-checkin
        $(this).find('.time-waited').html(toHM(timeBehindSchedule, true)); // set content of the time-waited td to minutes

    })
  }

  // The .duration td holds how long patient has been in exam rm.  The timestamp of when status became Checked In is
  // held in the tr's data-checkin-time.  We compute the time diff between now and checkin time and put this in the time-waited td.
  function updateExamTableTimes () {
    $('#examTableBody tr').each(function () {
      var starttime = $(this).data('exam-starttime');  // rows in exam table have start times in yyyy-mm-ddThh:mm:ss format
      elapsedTimeMin = calcElapsedTime(starttime);
      $(this).find('.duration').html(toHM(elapsedTimeMin)); // set content of the duration td to minutes

    })
  }

  function updateUpcomingTableTimes () {
    $('#upcomingAppointmentsTbody tr').each(function () {
      var schedTime = $(this).data('scheduled-time');
      elapsedTimeMin = calcElapsedTime(schedTime);
      if (elapsedTimeMin > 0)
        $(this).find('.late').html(toHM(elapsedTimeMin)); // set content of the duration td to minutes

    })
  }

  function updateTimes () {
    console.log("updating times");
    updateWaitingTableTimes();
    updateExamTableTimes();
    updateUpcomingTableTimes();
  }

  function trTag (appt_id, scheduled_time, checkin_time) {
    var r = "<tr data-appointment-id='" + appt_id + "' data-scheduled-time='" + scheduled_time + "'";
    if (checkin_time)
      r += " data-checkin-time='" + checkin_time + "'";
    r += ">";
    return r;
  }

  function reloadWaitingTableAppointments (appointments) {
    var $waitingTab = $('#waitingTableBody');
    $waitingTab.empty();
    for (var i=0;i<appointments.length;i++) {
      var pa = appointments[i];
      // get the wait time
      var timeBehindSchedule = calcElapsedTime(pa.checkin_time);
      var ddItems = {'exam': 'In Session', 'absent': 'No Show'}
      var dd = create_status_dropdown(pa.appointment_id, 'Checked In', ddItems);
      var tr = trTag(pa.appointment_id, pa.scheduled_time, pa.checkin_time);
      tr += "<td>" +pa.scheduled_time_12hr+ "</td> <td>" +toHM(timeBehindSchedule, true)+ "</td> <td>" +pa.first_name+ "</td> <td>" +pa.last_name+ "</td> <td>" +pa.reason+ "</td> <td>" +dd+ "</td> </tr>";
      $waitingTab.append(tr);
    }
  }

  function reloadUpcomingTableAppointments(appointments) {
    var $upcomingTab = $('#upcomingAppointmentsTbody');
    $upcomingTab.empty();
    for (var i=0;i<appointments.length;i++) {
      var pa = appointments[i];
      var patientLateTime = calcElapsedTime(pa.scheduled_time);
      var late = '';
      if (patientLateTime > 0)
        late = toHM(patientLateTime);
      var ddItems = {'absent': 'No Show'}
      var dd = create_status_dropdown(pa.appointment_id, '', ddItems);
      var tr = trTag(pa.appointment_id, pa.scheduled_time);
      tr += "<td>" +pa.scheduled_time_12hr+ "</td> <td>" +late+ "</td> <td>" +pa.first_name+ "</td> <td>" +pa.last_name+ "</td> <td>" +pa.reason+ "</td> <td>" +dd+ "</td> </tr>";
      $upcomingTab.append(tr);
    }

  }

  function handleStatusClick ($menuItem) {
      var stat = $menuItem.data('stat');
      var proceed = true;
      if (stat === 'complete')
          proceed = confirm("Proceed with status change to " + $menuItem.text());
      if (proceed) {
        $menuItem.parents(".dropdown").find('.btn').html($menuItem.text() + ' <span class="caret"></span>');
        $menuItem.parents(".dropdown").find('.btn').val($menuItem.data('stat'));
        statusUpdate($menuItem, $menuItem.attr('data-appointment-id'), stat);
      }
  }

  $( document ).ready(function () {
    // status dropdown items click handling
    $(document).on('click', '.status', function () {
      handleStatusClick($(this));

    });

    setInterval(updateTimes, 10*1000); // update patient durations and wait times every 10 secs
    setInterval(getScheduledAppointments, 20*1000); // update the schedule every minute.

  });

  </script>
{% endblock %}


{% block body %}

<div class="row">
  <div class="col-sm-10">
    <h3>In Exam Rooms</h3>
    <table class="table table-bordered">
      <thead>
      <th class="col-sm-1">time</th>
      <th class="col-sm-1">duration</th>
      <th class="col-sm-2">First</th>
      <th class="col-sm-2">Last</th>
      <th class="col-sm-4">Reason</th>
      <th class="col-sm-1">Status</th>
      </thead>
      <tbody id="examTableBody">
      {% for a in appointments %}
      {% if a.status == 'In Session' %}

      <tr data-appointment-id="{{ a.appointment_id }}" data-exam-starttime="{{ a.exam_starttime }}">
        <td>{{a.scheduled_time_12hr}}</td>
        <td class="duration"></td>
        <td>{{a.first_name}}</td>
        <td>{{a.last_name}}</td>
        <td>{{a.reason}}</td>
        <td>
          <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">{{ a.status }}
              <span class="caret"></span></button>
            <ul class="dropdown-menu">
              <li><a class="status" data-stat="complete" data-appointment-id="{{ a.appointment_id }}">Complete</a></li>
              <li><a class="status" data-stat="waiting" data-appointment-id="{{ a.appointment_id }}">Checked In</a></li>
            </ul>
          </div>
        </td>
      </tr>
      {% endif %}
      {% endfor %}
      </tbody>
    </table>

    <h3>In Waiting Room</h3>
    <table class="table table-bordered">
      <thead>
      <th class="col-sm-1">time</th>
      <th class="col-sm-1">Waiting time</th>
      <th class="col-sm-2">First</th>
      <th class="col-sm-2">Last</th>
      <th class="col-sm-5">Reason</th>
      <th class="col-sm-1">Status</th>
      </thead>
      <tbody id="waitingTableBody">
      {% for a in appointments %}
      {% if a.status == 'Checked In' or a.status == 'No Show'%}
      <tr data-appointment-id="{{ a.appointment_id }}" data-scheduled-time="{{ a.scheduled_time }}"
          data-checkin-time="{{ a.checkin_time }}">
        <td>{{a.scheduled_time_12hr}}</td>
        <td class="time-waited"></td>
        <td>{{a.first_name}}</td>
        <td>{{a.last_name}}</td>
        <td>{{a.reason}}</td>
        <td>
          <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">{{ a.status }}
              <span class="caret"></span></button>
            <ul class="dropdown-menu">
              <li><a class="status" data-stat="absent" data-appointment-id="{{ a.appointment_id }}">No Show</a></li>
              <li><a class="status" data-stat="exam" data-appointment-id="{{ a.appointment_id }}">In Session</a></li>
            </ul>
          </div>
        </td>
      </tr>
      {% endif %}
      {% endfor %}
      </tbody>
    </table>

    <h3>Upcoming Appointments</h3>
    <table class="table table-bordered">
      <thead>
      <th class="col-sm-1">time</th>
      <th class="col-sm-1"></th>
      <th class="col-sm-2">First</th>
      <th class="col-sm-2">Last</th>
      <th class="col-sm-5">Reason</th>
      <th class="col-sm-1">Status</th>
      </thead>
      <tbody id="upcomingAppointmentsTbody">
        {% for a in appointments %}
        {% if a.status != 'Checked In' and a.status != 'In Session'%}
        <tr data-appointment-id="{{ a.appointment_id }}" data-scheduled-time="{{ a.scheduled_time }}">
          <td>{{a.scheduled_time_12hr}}</td>
          <td class="late"></td>
          <td>{{a.first_name}}</td>
          <td>{{a.last_name}}</td>
          <td>{{a.reason}}</td>
          <td><div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">{{ a.status }}
              <span class="caret"></span></button>
            <ul class="dropdown-menu">
              <li><a class="status" data-stat="absent" data-appointment-id="{{ a.appointment_id }}">No Show</a></li>
            </ul>
          </div></td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="col-sm-2" style="background-color:yellow">
    statistics will go here
  </div>
</div>
<!--{{ doctor }}-->
{% endblock %}